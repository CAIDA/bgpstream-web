libBGPStream Tutorial
=====================

<h1 class="text-danger">TODO: REVIEW THIS DOCUMENT</h1>

libBGPStream is a C library that facilitate the creation of a sorted
stream of BGP records. More details are available at @@link to libbgpstream overview, whereas
the complete documentation is available at @@link to libbgpstream docs.

Below we provide the following tutorials:

* [Get familiar with the API: count the BGP elems](#api1) ([code]({{ asset('bundles/caidabgpstreamwebhomepage/docs/tutorials/code/bgpstream-tutorial.c') }}))
* [Prefix monitoring](#api2) ([code]({{ asset('bundles/caidabgpstreamwebhomepage/docs/tutorials/code/bgpstream-pfx-mon.c') }}))

<br>

## Get familiar with the API: count the BGP elems ##   {% verbatim %}{#api1}{% endverbatim %}

In this example we show how to use most of the C library API functions
to count the BGP elems in the current stream.
The example is fully functioning and it can be compiled
and run using the following commands:

~~~ 
$ gcc ./bgpstream-tutorial.c  -lbgpstream -o ./tutorial
$ ./tutorial
Read 5519 elems
~~~

<br>

The program instantiates an instance of BGPStream that uses the CAIDA
broker as data interface (default), and it counts the elems that match
the filters (collectors, record type, and time).

<br>

### Step by step description

The first step in each program using libBGPStream, is to allocate
memory for a BGPStream instance and for a BGPStream record. The latter
is a re-usable memory allocation that is going to contain the most
recent record read. 

~~~ .language-c
bgpstream_t *bs = bs = bgpstream_create();
bgpstream_record_t *bs_record = bgpstream_record_create();
~~~

<br>

The second step consists in customizing the stream using the project,
collector, type, and time interval filters. The time interval filter
is mandatory, whereas the others are optional. In this specific case,
we are configuring the stream to return the BGP records read from
Updates dumps generated by RRC06 and Route View Jinx collectors,
having a timestamp in the interval 10:10:10 - 11:11:11 Sun, 10 Oct
2010 GMT.


~~~ .language-c

bgpstream_add_filter(bs, BGPSTREAM_FILTER_TYPE_COLLECTOR, "rrc06");
bgpstream_add_filter(bs, BGPSTREAM_FILTER_TYPE_COLLECTOR, "route-views.jinx");

bgpstream_add_filter(bs, BGPSTREAM_FILTER_TYPE_RECORD_TYPE, "updates");

bgpstream_add_interval_filter(bs,1286705410,1286709071);
~~~

<br>

At this point we can start the stream, and repeatedly ask for new
BGP records and BGP elems (the *bs_elem* pointer points to memory that is borrowed
from BGPStream, one has to use the API copy function to own the
memory). Each time a valid record is read, we extract the
elems that it contains, and we increment a counter.


~~~ .language-c
bgpstream_elem_t *bs_elem = NULL;

do
  {  
   get_next_ret = bgpstream_get_next_record(bs, bs_record);
   if(get_next_ret && bs_record->status == BGPSTREAM_RECORD_STATUS_VALID_RECORD)
    {
     while((bs_elem = bgpstream_record_get_next_elem (bs_record)) != NULL)
      {
       elem_counter++;
      }
    }
  }
while(get_next_ret > 0);
~~~

Once the entire stream has been read, we can print the results, and de-allocate the memory
allocated for the BGPStream record and the BGPStream instance.

~~~ .language-c
printf("\tRead %d elems\n", elem_counter);

bgpstream_record_destroy(bs_record);
bgpstream_destroy(bs);
~~~

<br>

### Complete Example

Get the [code]({{
asset('bundles/caidabgpstreamwebhomepage/docs/tutorials/code/bgpstream-tutorial.c')
}}).

~~~ .language-c
{% include '@CAIDABGPStreamWebHomepageBundle/Resources/public/docs/tutorials/code/bgpstream-tutorial.c' %}
~~~

<br>

## Prefix monitoring ##  {% verbatim %}{#api2}{% endverbatim %}

In this second example, we show how to implement a program that
outputs all the announcements and withdrawal messages for a specific
prefix, ___2403:f600::/32___,  observed by Route Views 2 and RRC00 
during the time interval ___01:20:10 - 06:32:15 on Tue, 12 Aug 2014 UTC___.
The example is fully functioning and it can be compiled
and run using the following commands:

~~~
$ gcc ./bgpstream-pfx-mon.c  -lbgpstream -o ./pfx-monitoring
$ ./pfx-monitoring
   U|A|1407813784|ris|rrc00|6881|2a02:38::2|2403:f600::/32|2a02:38::2|6881 6939 4826 38456 55722|55722||
   U|W|1407813784|ris|rrc00|50300|2a00:1c10:10::8|2403:f600::/32|||||
   U|A|1407813786|ris|rrc00|57381|2001:67c:24e4:1::1|2403:f600::/32|2001:67c:24e4:1::1|57381 50304 10026 38456 55722|55722||
   ...
   U|A|1407814216|ris|rrc00|57381|2001:67c:24e4:1::1|2403:f600::/32|2001:67c:24e4:1::1|57381 42708 10026 38456 55722|55722||
   U|A|1407814218|ris|rrc00|29608|2a01:678::2|2403:f600::/32|2a01:678::2|29608 6939 4826 38456 55722|55722||
   U|A|1407814228|ris|rrc00|45896|2001:df0:2e8:1000::1|2403:f600::/32|2001:df0:2e8:1000::1|45896 4826 38456 55722|55722||
~~~
  
<br>

### Step by step description


The program stores in a ___pfx_storage___ structure the prefix to
monitor. The user can provide the prefix as a string and then convert
it into the BGPStream prefix data structure using the BGPStream utils @@link to overview.

~~~ .language-c
bgpstream_pfx_storage_t my_pfx;
bgpstream_str2pfx( "2403:f600::/32", &my_pfx);
~~~

<br>

The configuration of the stream through a set of filters is similar to
the previous [example](#api1).


~~~ .language-c
bgpstream_add_filter(bs, BGPSTREAM_FILTER_TYPE_COLLECTOR, "rrc00");
bgpstream_add_filter(bs, BGPSTREAM_FILTER_TYPE_COLLECTOR, "route-views2");
  
bgpstream_add_filter(bs, BGPSTREAM_FILTER_TYPE_RECORD_TYPE, "updates");

bgpstream_add_interval_filter(bs, 1407806410, 1407825135);
~~~

<br>

Finally, for each elem, the program prints out only the information
associated with announcements and withdrawals related to the selected
prefix. 

~~~ .language-c
if (( elem->type == BGPSTREAM_ELEM_TYPE_ANNOUNCEMENT ||
      elem->type == BGPSTREAM_ELEM_TYPE_WITHDRAWAL) &&
      bgpstream_pfx_storage_equal(&my_pfx, &elem->prefix))
      { 
       bgpstream_record_elem_snprintf(buffer, 1024, record, elem);
       fprintf(stdout, "%s\n", buffer);
      }
~~~

<br>

### Complete Example

Get the [code]({{
asset('bundles/caidabgpstreamwebhomepage/docs/tutorials/code/bgpstream-pfx-mon.c')
}}).

~~~ .language-c
{% include '@CAIDABGPStreamWebHomepageBundle/Resources/public/docs/tutorials/code/bgpstream-pfx-mon.c' %}
~~~



